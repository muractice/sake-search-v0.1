name: Sync Sake Data with History

on:
  # å®šæœŸå®Ÿè¡Œ: æ¯æ—¥ AM 2:00 JST (å‰æ—¥ 17:00 UTC)
  schedule:
    - cron: '0 17 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (å¤‰æ›´ã‚’é©ç”¨ã—ãªã„)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync:
    name: Sync Sake Data from Sakenowa API
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    defaults:
      run:
        working-directory: ./sake-search-nextjs
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./sake-search-nextjs/package-lock.json
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ./sake-search-nextjs/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install dependencies
        run: |
          npm ci --production
          npm install @supabase/supabase-js
      
      - name: Run database migrations
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
          # npx supabase db push --db-url "$SUPABASE_URL"
      
      - name: Run sync script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          NODE_ENV: production
        run: |
          echo "ğŸ¶ Starting sake data sync..."
          echo "DRY_RUN mode: $DRY_RUN"
          node scripts/sync-sake-data-with-history.js
      
      - name: Generate change report
        if: always()
        run: |
          # æœ€æ–°ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã¤ã‘ã‚‹
          LATEST_REPORT=$(ls -t logs/sync-report-*.json 2>/dev/null | head -1)
          if [ -f "$LATEST_REPORT" ]; then
            echo "ğŸ“Š Sync Report Summary:"
            cat "$LATEST_REPORT" | jq '{
              generation_id,
              sync_date,
              duration_ms,
              changes_summary,
              dry_run
            }'
          else
            echo "âš ï¸ No report file found"
          fi
      
      - name: Upload sync reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-reports-${{ github.run_id }}
          path: |
            sake-search-nextjs/logs/*.json
          retention-days: 90
          if-no-files-found: warn
      
      - name: Check for errors
        if: failure()
        run: |
          echo "âŒ Sync failed. Checking error logs..."
          ERROR_REPORT=$(ls -t logs/error-report-*.json 2>/dev/null | head -1)
          if [ -f "$ERROR_REPORT" ]; then
            echo "Error details:"
            cat "$ERROR_REPORT" | jq '.error'
          fi
      
      - name: Notify on Slack (Success with major changes)
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          # Slackã¸ã®é€šçŸ¥ï¼ˆé‡è¦ãªå¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
          if [ -n "$SLACK_WEBHOOK" ]; then
            LATEST_REPORT=$(ls -t logs/sync-report-*.json 2>/dev/null | head -1)
            if [ -f "$LATEST_REPORT" ]; then
              CHANGES=$(cat "$LATEST_REPORT" | jq -r '.changes_summary')
              INSERTS=$(echo "$CHANGES" | jq -r '.inserts')
              UPDATES=$(echo "$CHANGES" | jq -r '.updates')
              DELETES=$(echo "$CHANGES" | jq -r '.deletes')
              
              # å¤‰æ›´ãŒ10ä»¶ä»¥ä¸Šã‚ã‚‹å ´åˆã®ã¿é€šçŸ¥
              TOTAL=$((INSERTS + UPDATES + DELETES))
              if [ "$TOTAL" -ge 10 ]; then
                curl -X POST "$SLACK_WEBHOOK" \
                  -H 'Content-Type: application/json' \
                  -d "{
                    \"text\": \"ğŸ¶ Sake Data Sync completed with major changes\",
                    \"blocks\": [{
                      \"type\": \"section\",
                      \"text\": {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Sync Results*\\nâ€¢ New: $INSERTS\\nâ€¢ Updated: $UPDATES\\nâ€¢ Deleted: $DELETES\"
                      }
                    }]
                  }"
              fi
            fi
          fi
      
      - name: Notify on Slack (Failure)
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST "$SLACK_WEBHOOK" \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "ğŸš¨ Sake Data Sync Failed",
                "blocks": [{
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Sync Failed*\nRun ID: ${{ github.run_id }}\nCheck the logs for details."
                  }
                }]
              }'
          fi

  # å®šæœŸçš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¸ãƒ§ãƒ–ï¼ˆé€±æ¬¡ï¼‰
  cleanup:
    name: Cleanup old sync data
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 17 * * 0'  # æ—¥æ›œæ—¥ã®ã¿å®Ÿè¡Œ
    
    steps:
      - name: Cleanup old generations
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ğŸ§¹ Cleaning up old sync data (keeping last 30 days)..."
          # 30æ—¥ä»¥ä¸Šå‰ã®å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹SQLã‚’å®Ÿè¡Œ
          # ã“ã‚Œã¯åˆ¥é€”ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å®Ÿè£…