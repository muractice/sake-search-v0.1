# 好み分析・レコメンド機能 - 詳細仕様

## 機能概要
ユーザーのお気に入りと飲酒記録データから個人の好みを分析し、
最適な日本酒をレコメンドする機能。「自分の飲みたいお酒を選択しやすくする」という
コアバリューを実現する中核機能。

## 目的
1. **好みの可視化**: 自分の好みの傾向を理解
2. **新しい発見**: 知らない日本酒との出会い
3. **選択の支援**: 飲食店・酒屋での意思決定サポート
4. **体験の最適化**: 気分やシチュエーションに応じた提案

## 機能要件

### 1. 好み分析エンジン

#### 分析データソース
- **お気に入り登録**: 重み 3.0
- **高評価記録（★4-5）**: 重み 2.0
- **中評価記録（★3）**: 重み 1.0
- **検索・閲覧履歴**: 重み 0.5
- **比較リスト追加**: 重み 0.8

#### 好みベクトルの算出
```typescript
interface PreferenceVector {
  // 基本味覚（-5 to +5）
  sweetness: number;      // 甘辛度の好み
  richness: number;       // 淡濃度の好み
  
  // 詳細特性（0 to 1）
  f1_floral: number;      // 華やか度の好み
  f2_mellow: number;      // 芳醇度の好み
  f3_heavy: number;       // 重厚度の好み
  f4_mild: number;        // 穏やか度の好み
  f5_dry: number;         // ドライ度の好み
  f6_light: number;       // 軽快度の好み
  
  // 嗜好特性
  diversity_score: number; // 多様性スコア（0-1）
  adventure_score: number; // 冒険度スコア（0-1）
}
```

#### 分析ロジック
1. **重み付き平均**: データソースごとの重みで平均値算出
2. **時間減衰**: 古いデータは徐々に影響度を下げる
3. **外れ値処理**: 極端な値は影響を制限
4. **正規化**: 各指標を0-1または-5~+5に正規化

### 2. 好みの可視化

#### 好みマップ
- **4象限プロット**: ユーザーの好みの中心点を表示
- **好みゾーン**: 好みの範囲を円or楕円で表示
- **お気に入り分布**: 実際のお気に入りをプロット

#### 好みレーダーチャート
- 6要素（f1-f6）の好み傾向を可視化
- 平均的な日本酒愛好家との比較表示

#### タイプ診断
**味覚タイプ分類**
- 🌸 **華やか系**: f1（華やか度）が高い
- 🍯 **まろやか系**: f2（芳醇度）が高い
- ⚔️ **重厚系**: f3（重厚度）が高い
- 🍃 **穏やか系**: f4（穏やか度）が高い
- 💎 **キレ系**: f5（ドライ度）が高い
- 🦋 **軽快系**: f6（軽快度）が高い
- 🎭 **バランス型**: 全体的に均等
- 🚀 **冒険家型**: 多様性スコアが高い

### 3. レコメンドアルゴリズム

#### 基本レコメンド
**類似度ベース推薦**
```typescript
function calculateSimilarity(sake: Sake, preference: PreferenceVector): number {
  // ユークリッド距離の逆数
  const distance = Math.sqrt(
    Math.pow(sake.sweetness - preference.sweetness, 2) +
    Math.pow(sake.richness - preference.richness, 2) +
    // ... 他の要素
  );
  return 1 / (1 + distance);
}
```

#### スマートレコメンド
**コンテキスト認識型推薦**

1. **気分別レコメンド**
   - 「いつもの安心」: 好みゾーン内から選択
   - 「ちょっと冒険」: 好みゾーンの境界付近
   - 「新しい発見」: 好みと反対の特性
   - 「今日は特別」: 高評価の上位から

2. **シチュエーション別**
   - **食事と一緒**: 料理ペアリング考慮
   - **プレゼント用**: 人気度・知名度重視
   - **家飲み**: コスパ重視
   - **記念日**: プレミアム銘柄

3. **季節別レコメンド**
   - **春**: 華やかで軽快なタイプ
   - **夏**: さっぱりドライなタイプ
   - **秋**: まろやかで深みのあるタイプ
   - **冬**: 重厚で温まるタイプ

#### 探索と活用のバランス
```typescript
interface RecommendationStrategy {
  exploitation: number; // 好みに合うもの（70%）
  exploration: number;  // 新しい発見（20%）
  trending: number;     // トレンド・人気（10%）
}
```

### 4. レコメンド表示

#### おすすめリスト
**カテゴリ別表示**
- 「あなたにぴったり」: 最も好みに近い
- 「新しい出会い」: 未体験ゾーンから
- 「みんなのお気に入り」: 高評価ランキング
- 「季節のおすすめ」: 時期に応じた提案
- 「最近話題の」: トレンド銘柄

#### 理由の説明
```
おすすめ理由：
✓ あなたの好きな「獺祭」に味が似ています
✓ 華やかさ（f1）があなたの好みと一致
✓ 同じ山口県の日本酒です
```

#### 好み度予測
- **予測スコア**: 0-100%で表示
- **信頼度**: 予測の確からしさを表示
- **類似お気に入り**: 似ているお気に入りを表示

### 5. フィードバックループ

#### 暗黙的フィードバック
- 検索後の行動（詳細表示、比較追加）
- 滞在時間
- スクロール深度

#### 明示的フィードバック
- 「興味あり」「興味なし」ボタン
- レコメンド後の実際の評価
- 「なぜおすすめ？」への反応

#### 学習と最適化
- A/Bテストによるアルゴリズム改善
- 個人別のパラメータ調整
- 季節・時間帯による重み変更

## データ構造

### ユーザー好み分析データ
```typescript
interface UserPreference {
  user_id: string;
  
  // 好みベクトル
  preference_vector: PreferenceVector;
  
  // タイプ分類
  taste_type: string[];
  primary_type: string;
  
  // 統計情報
  total_favorites: number;
  total_records: number;
  average_rating: number;
  
  // 多様性指標
  diversity_score: number;
  adventure_score: number;
  consistency_score: number;
  
  // 更新情報
  last_calculated: Date;
  calculation_version: string;
}
```

### レコメンド結果
```typescript
interface Recommendation {
  id: string;
  user_id: string;
  sake_id: string;
  
  // スコアリング
  similarity_score: number;    // 類似度
  predicted_rating: number;     // 予測評価
  confidence_level: number;     // 信頼度
  
  // レコメンド理由
  reasons: string[];
  category: string;
  
  // メタデータ
  created_at: Date;
  clicked: boolean;
  feedback: 'positive' | 'negative' | null;
}
```

## UI/UX設計

### 好み分析ダッシュボード
```
┌─────────────────────────┐
│ 🎯 あなたの好み分析       │
├─────────────────────────┤
│ タイプ: 🌸華やか系        │
│                         │
│ [4象限マップ表示]         │
│ [レーダーチャート]        │
│                         │
│ 好みの特徴:              │
│ • 甘口寄り（+2.3）       │
│ • 華やかな香りを好む      │
│ • 軽快な飲み口を重視      │
├─────────────────────────┤
│ 多様性: ■■■□□ 60%      │
│ 冒険度: ■■■■□ 80%      │
└─────────────────────────┘
```

### レコメンド表示
```
┌─────────────────────────┐
│ 💡 あなたへのおすすめ     │
├─────────────────────────┤
│ 【あなたにぴったり】       │
│ ┌─────────────┐        │
│ │🍶 新政 No.6  │        │
│ │好み度: 95%   │        │
│ │理由: 華やかで │        │
│ │      軽快    │        │
│ └─────────────┘        │
├─────────────────────────┤
│ 【新しい出会い】          │
│ ┌─────────────┐        │
│ │🍶 黒龍       │        │
│ │好み度: 72%   │        │
│ │理由: 新境地   │        │
│ └─────────────┘        │
└─────────────────────────┘
```

### 気分選択UI
```
今日の気分は？

[🏠 いつもの] [🎲 ちょっと冒険]
[🚀 新しい発見] [✨ 特別な日]
```

## 実装優先度

### Phase 1（MVP）
1. 基本的な好み分析（甘辛×淡濃）
2. 類似度ベースのシンプルレコメンド
3. 好みマップの表示

### Phase 2
1. 6要素分析の追加
2. タイプ診断機能
3. レコメンド理由の表示

### Phase 3
1. 気分別レコメンド
2. 季節別レコメンド
3. フィードバック機能

### Phase 4
1. 機械学習モデルの導入
2. リアルタイム最適化
3. A/Bテスト基盤

## 技術実装メモ

### アルゴリズム選定
- **初期**: コサイン類似度 + 重み付き平均
- **中期**: 協調フィルタリング（User-based CF）
- **長期**: ディープラーニング（Neural CF）

### パフォーマンス最適化
- レコメンド結果のキャッシュ（1日更新）
- 好みベクトルの差分更新
- バッチ処理での事前計算

### 評価指標
- **適合率（Precision）**: おすすめの的中率
- **再現率（Recall）**: 好きなものをカバーできているか
- **多様性（Diversity）**: レコメンドの幅広さ
- **新規性（Novelty）**: 知らないものを提案できているか

### エシカル配慮
- フィルターバブルの回避
- 多様性の確保
- プライバシー保護（データの匿名化）