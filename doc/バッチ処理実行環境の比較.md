# ãƒãƒƒãƒå‡¦ç†å®Ÿè¡Œç’°å¢ƒã®æ¯”è¼ƒï¼šGitHub Actions vs Vercel Cron

## ğŸ“Š è©³ç´°æ¯”è¼ƒè¡¨

| é …ç›® | GitHub Actions | Vercel Cron |
|------|---------------|-------------|
| **æ–™é‡‘** | âœ… ç„¡æ–™ï¼ˆ2,000åˆ†/æœˆï¼‰ | âŒ æœ‰æ–™ï¼ˆPro: $20/æœˆã€œï¼‰ |
| **å®Ÿè¡Œæ™‚é–“åˆ¶é™** | âœ… æœ€å¤§6æ™‚é–“ | âŒ 10ç§’ã€œ5åˆ† |
| **ãƒ‡ãƒ¼ã‚¿å‡¦ç†** | âœ… 3,167ä»¶å‡¦ç†å¯èƒ½ | âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒªã‚¹ã‚¯ |
| **è¨­å®šã®ç°¡å˜ã•** | âœ… YAMLãƒ•ã‚¡ã‚¤ãƒ« | âš ï¸ APIå®Ÿè£…å¿…è¦ |
| **ãƒ­ã‚°ãƒ»ç›£è¦–** | âœ… è©³ç´°ãªãƒ­ã‚°UI | âš ï¸ åŸºæœ¬çš„ãªãƒ­ã‚° |
| **ã‚¨ãƒ©ãƒ¼é€šçŸ¥** | âœ… å¤šæ§˜ãªé€šçŸ¥æ–¹æ³• | âš ï¸ é™å®šçš„ |
| **ãƒªãƒˆãƒ©ã‚¤** | âœ… è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ | âŒ æ‰‹å‹•å®Ÿè£…å¿…è¦ |
| **ç’°å¢ƒå¤‰æ•°** | âœ… Secretsç®¡ç† | âœ… ç’°å¢ƒå¤‰æ•°å¯¾å¿œ |

## ğŸ¯ **æ¨å¥¨ï¼šGitHub Actions**

### æ±ºå®šçš„ãªç†ç”±

#### 1. ğŸ’° ã‚³ã‚¹ãƒˆå„ªä½æ€§
```
GitHub Actions: $0ï¼ˆç„¡æ–™æ ã§ååˆ†ï¼‰
- å¿…è¦æ™‚é–“: 5åˆ†/æ—¥ Ã— 30æ—¥ = 150åˆ†/æœˆ
- ç„¡æ–™æ : 2,000åˆ†/æœˆ
- ä½™è£•åº¦: 13å€

Vercel Cron: $20/æœˆã€œ
- Pro Planå¿…é ˆ
- è¿½åŠ ã‚³ã‚¹ãƒˆãŒç™ºç”Ÿ
```

#### 2. â±ï¸ å®Ÿè¡Œæ™‚é–“ã®ä½™è£•
```
æƒ³å®šå‡¦ç†æ™‚é–“: 3-5åˆ†
- APIå–å¾—: 1åˆ†
- ãƒ‡ãƒ¼ã‚¿å¤‰æ›: 1åˆ†
- DBæ›´æ–°: 2-3åˆ†

GitHub Actions: âœ… 6æ™‚é–“ã¾ã§ä½™è£•
Vercel Cron: âŒ 5åˆ†ã§ã‚®ãƒªã‚®ãƒª
```

#### 3. ğŸ”§ å®Ÿè£…ã®æŸ”è»Ÿæ€§
GitHub Actionsãªã‚‰ï¼š
- Node.jsã€Pythonã€ä»»æ„ã®è¨€èªã§å®Ÿè£…å¯èƒ½
- è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®åˆ†å‰²å®Ÿè¡Œ
- æ¡ä»¶åˆ†å²ã‚„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒè±Šå¯Œ

## å®Ÿè£…ä¾‹

### GitHub Actionsï¼ˆæ¨å¥¨ï¼‰

```yaml
# .github/workflows/sync-sake-data.yml
name: Sync Sake Data from Sakenowa API

on:
  schedule:
    # æ¯æ—¥ AM 2:00 JST (å‰æ—¥ 17:00 UTC)
    - cron: '0 17 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      force_full_sync:
        description: 'Force full data sync'
        required: false
        default: 'false'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --only=production
      
      - name: Run sync script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          node scripts/sync-sake-data.js
      
      - name: Upload sync report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-report-${{ github.run_id }}
          path: logs/sync-*.json
          retention-days: 30
      
      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'ğŸš¨ Sake data sync failed!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

### åŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆscripts/sync-sake-data.jsï¼‰

```javascript
// scripts/sync-sake-data.js
import { createClient } from '@supabase/supabase-js';
import fs from 'fs/promises';

class SakeDataSynchronizer {
  constructor() {
    this.supabase = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );
    this.stats = {
      startTime: new Date(),
      processed: 0,
      inserted: 0,
      updated: 0,
      errors: []
    };
  }

  async run() {
    console.log('ğŸ¶ Starting Sake data sync...');
    
    try {
      // 1. åŒæœŸé–‹å§‹ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
      await this.logSyncStart();
      
      // 2. ã•ã‘ã®ã‚APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
      console.log('ğŸ“¥ Fetching data from Sakenowa API...');
      const data = await this.fetchAllData();
      console.log(`âœ… Fetched ${data.length} sake records`);
      
      // 3. ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã¨ãƒ™ã‚¯ãƒˆãƒ«åŒ–
      console.log('ğŸ”„ Transforming data...');
      const transformed = await this.transformData(data);
      
      // 4. ãƒãƒƒãƒæ›´æ–°ï¼ˆ500ä»¶ãšã¤ï¼‰
      console.log('ğŸ’¾ Updating database...');
      await this.batchUpsert(transformed);
      
      // 5. çµ±è¨ˆæƒ…å ±ã‚’ä¿å­˜
      await this.saveStats();
      
      console.log('âœ… Sync completed successfully!');
      console.log(this.stats);
      
    } catch (error) {
      console.error('âŒ Sync failed:', error);
      this.stats.errors.push(error.message);
      await this.logSyncError(error);
      process.exit(1);
    }
  }

  async fetchAllData() {
    const [brands, breweries, flavorCharts] = await Promise.all([
      fetch('https://muro.sakenowa.com/sakenowa-data/api/brands')
        .then(r => r.json()),
      fetch('https://muro.sakenowa.com/sakenowa-data/api/breweries')
        .then(r => r.json()),
      fetch('https://muro.sakenowa.com/sakenowa-data/api/flavor-charts')
        .then(r => r.json())
    ]);

    return this.mergeData(brands.brands, breweries.breweries, flavorCharts.flavorCharts);
  }

  async batchUpsert(data, batchSize = 500) {
    for (let i = 0; i < data.length; i += batchSize) {
      const batch = data.slice(i, i + batchSize);
      
      const { error } = await this.supabase
        .from('sake_master')
        .upsert(batch, {
          onConflict: 'brand_id',
          ignoreDuplicates: false
        });

      if (error) {
        this.stats.errors.push(`Batch ${i}: ${error.message}`);
        throw error;
      }

      this.stats.processed += batch.length;
      console.log(`Progress: ${this.stats.processed}/${data.length}`);
    }
  }

  async saveStats() {
    const report = {
      ...this.stats,
      endTime: new Date(),
      duration: Date.now() - this.stats.startTime.getTime()
    };

    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ä¿å­˜
    await fs.writeFile(
      `logs/sync-${Date.now()}.json`,
      JSON.stringify(report, null, 2)
    );

    // Supabaseã«åŒæœŸãƒ­ã‚°ä¿å­˜
    await this.supabase
      .from('sync_logs')
      .insert({
        sync_type: 'full',
        total_records: this.stats.processed,
        inserted_count: this.stats.inserted,
        updated_count: this.stats.updated,
        error_count: this.stats.errors.length,
        status: 'completed'
      });
  }
}

// å®Ÿè¡Œ
const sync = new SakeDataSynchronizer();
sync.run();
```

### Vercel Cronï¼ˆéæ¨å¥¨ã ãŒå‚è€ƒï¼‰

```typescript
// app/api/cron/sync-sake/route.ts
import { NextResponse } from 'next/server';

export const maxDuration = 300; // 5åˆ†ï¼ˆPro Planã®ã¿ï¼‰

export async function GET(request: Request) {
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: Cron Secretæ¤œè¨¼
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response('Unauthorized', { status: 401 });
  }

  try {
    // æ³¨æ„: 5åˆ†ä»¥å†…ã«å®Œäº†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
    const result = await syncSakeData();
    return NextResponse.json({ success: true, ...result });
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚5åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    return NextResponse.json({ success: false, error }, { status: 500 });
  }
}
```

```json
// vercel.json
{
  "crons": [{
    "path": "/api/cron/sync-sake",
    "schedule": "0 17 * * *"  // æ¯æ—¥ AM 2:00 JST
  }]
}
```

## ğŸ“Š ã‚·ãƒŠãƒªã‚ªåˆ¥ã®æ¨å¥¨

### ã‚±ãƒ¼ã‚¹1: æ¨™æº–çš„ãªæ—¥æœ¬é…’ã‚¢ãƒ—ãƒªï¼ˆæ¨å¥¨ã‚·ãƒŠãƒªã‚ªï¼‰
**â†’ GitHub Actions**
- 3,167ä»¶ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã«ä½™è£•
- ç„¡æ–™ã§é‹ç”¨å¯èƒ½
- è©³ç´°ãªãƒ­ã‚°ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚±ãƒ¼ã‚¹2: æ—¢ã«Vercel Proã‚’ä½¿ç”¨ä¸­
**â†’ ãã‚Œã§ã‚‚GitHub Actionsæ¨å¥¨**
- å®Ÿè¡Œæ™‚é–“ã®åˆ¶ç´„ãŒãã¤ã„
- ãƒãƒƒãƒå‡¦ç†ã«ã¯ä¸å‘ã

### ã‚±ãƒ¼ã‚¹3: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒå¿…è¦
**â†’ åˆ¥ã®æ–¹å¼ã‚’æ¤œè¨**
- Webhookãƒ™ãƒ¼ã‚¹ã®æ›´æ–°
- ã‚¤ãƒ™ãƒ³ãƒˆãƒ‰ãƒªãƒ–ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## ğŸš€ å®Ÿè£…æ‰‹é †ï¼ˆGitHub Actionsï¼‰

### Step 1: Secretsã®è¨­å®š
```bash
# GitHubãƒªãƒã‚¸ãƒˆãƒªè¨­å®š > Secrets and variables > Actions
SUPABASE_URL=your-project-url
SUPABASE_SERVICE_KEY=your-service-key
SLACK_WEBHOOK=your-webhook-url  # ã‚ªãƒ—ã‚·ãƒ§ãƒ³
```

### Step 2: ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
```bash
mkdir -p scripts logs
touch scripts/sync-sake-data.js
```

### Step 3: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ
```bash
mkdir -p .github/workflows
touch .github/workflows/sync-sake-data.yml
```

### Step 4: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ
node scripts/sync-sake-data.js

# GitHub Actionsã§æ‰‹å‹•å®Ÿè¡Œ
# Actions ã‚¿ãƒ– > Sync Sake Data > Run workflow
```

## ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

### GitHub Actions ã®ç›£è¦–æ©Ÿèƒ½
- âœ… å®Ÿè¡Œå±¥æ­´ã®å¯è¦–åŒ–
- âœ… å¤±æ•—æ™‚ã®è‡ªå‹•é€šçŸ¥ï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‰
- âœ… Slack/Discordé€£æºå¯èƒ½
- âœ… è©³ç´°ãªãƒ­ã‚°ä¿å­˜ï¼ˆ30æ—¥é–“ï¼‰

### æ¨å¥¨ç›£è¦–è¨­å®š
```yaml
# ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿Slacké€šçŸ¥
- name: Notify on failure
  if: failure()
  run: |
    curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
      -H 'Content-Type: application/json' \
      -d '{
        "text": "ğŸš¨ Sake sync failed!",
        "blocks": [{
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*Sync Failed*\nRun: ${{ github.run_id }}\nError: Check logs"
          }
        }]
      }'
```

## çµè«–

### ğŸ† **GitHub Actions ã‚’å¼·ãæ¨å¥¨**

ç†ç”±ï¼š
1. **ç„¡æ–™** ã§ååˆ†ãªå®Ÿè¡Œæ™‚é–“
2. **6æ™‚é–“**ã®ä½™è£•ã‚ã‚‹åˆ¶é™
3. **è±Šå¯Œãªæ©Ÿèƒ½**ã¨æŸ”è»Ÿæ€§
4. **å®Ÿç¸¾ã®ã‚ã‚‹**ãƒãƒƒãƒå‡¦ç†ç’°å¢ƒ

Vercel Cronã¯ï¼š
- Webã‚¢ãƒ—ãƒªå†…ã®è»½é‡ã‚¿ã‚¹ã‚¯å‘ã‘
- å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã«ã¯ä¸é©åˆ‡
- ã‚³ã‚¹ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªã„